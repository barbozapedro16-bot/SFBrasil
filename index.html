<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SimFut">
    <meta name="theme-color" content="#121212">

    <title>SimFut Brasil</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #121212; font-family: 'Segoe UI', system-ui, sans-serif; overflow-x: hidden; user-select: none; }
        
        /* Tabela */
        .table-custom { font-size: 0.85rem; }
        .table-custom th { background-color: #1f1f1f; border-bottom: 2px solid #333; font-weight: 700; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; color: #888; }
        .table-custom td { vertical-align: middle; background-color: #1a1a1a; border-color: #2c2c2c; height: 40px; }
        .table-hover tbody tr:hover td { background-color: #252525; }
        
        /* Cards de Jogo */
        .match-card { background: #1e1e1e; border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid #333; min-height: 55px; display: flex; align-items: center; justify-content: space-between; }
        .match-card:hover { border-color: #555; background: #222; }
        .team-name { font-weight: 600; width: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .score-display { background: #000; padding: 3px 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1rem; color: #fbbf24; min-width: 75px; text-align: center; border: 1px solid #333; }
        .score-empty { color: #444; border-color: #222; }
        .score-area { width: 30%; display: flex; justify-content: center; align-items: center; gap: 5px; }

        /* BotÃµes */
        .btn-play-single { border-radius: 50%; width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: #ffc107; border: none; color: black; font-size: 0.8rem; box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
        .btn-play-single:active { transform: scale(0.9); }
        
        /* Bracket (Mata-mata) */
        .bracket-container { display: flex; overflow-x: auto; padding: 20px 10px; height: 100%; align-items: flex-start; scroll-behavior: smooth; }
        .bracket-round { min-width: 220px; margin-right: 25px; display: flex; flex-direction: column; justify-content: center; }
        .bracket-title { text-align: center; font-size: 0.75rem; text-transform: uppercase; color: #6c757d; margin-bottom: 12px; font-weight: bold; border-bottom: 2px solid #333; padding-bottom: 4px; }
        .bracket-match { background: #262626; border: 1px solid #404040; border-radius: 6px; padding: 8px; margin-bottom: 12px; position: relative; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .bracket-team { display: flex; justify-content: space-between; padding: 2px 0; align-items: center; }
        .bracket-score { font-family: monospace; font-weight: bold; background: #111; padding: 1px 6px; border-radius: 3px; min-width: 20px; text-align: center; font-size: 0.9em; color: #eee; }
        .winner-text { color: #fbbf24; }

        /* Zonas da Tabela */
        .z-liberta { border-left: 4px solid #3b82f6; background: linear-gradient(90deg, rgba(59,130,246,0.05) 0%, rgba(0,0,0,0) 100%); }
        .z-prelib { border-left: 4px solid #0ea5e9; }
        .z-sula { border-left: 4px solid #22c55e; }
        .z-rebaix { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239,68,68,0.05) 0%, rgba(0,0,0,0) 100%); }
        .z-acesso { border-left: 4px solid #3b82f6; background: linear-gradient(90deg, rgba(59,130,246,0.05) 0%, rgba(0,0,0,0) 100%); }
        .z-neutro { border-left: 4px solid transparent; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary fixed-top" style="height: 60px;">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <i class="fas fa-futbol text-warning me-2"></i>
            <div style="line-height: 1.1;">
                <div class="fw-bold" style="font-size: 1rem;">SimFut Brasil</div>
                <div class="badge bg-secondary text-white" style="font-size: 0.6rem; padding: 2px 6px;" id="anoLabel">2026</div>
            </div>
        </a>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm bg-secondary text-white border-0" id="selectLiga" style="width: 140px; font-weight: 500;"></select>
            
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="fas fa-cog"></i></button>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                    <li><a class="dropdown-item" href="#" onclick="app.exportarSave()"><i class="fas fa-download me-2"></i>Salvar Jogo</a></li>
                    <li><a class="dropdown-item" href="#" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload me-2"></i>Carregar Jogo</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="app.hardReset()"><i class="fas fa-trash me-2"></i>Novo Jogo</a></li>
                </ul>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="app.importarSave(this)">
        </div>
    </div>
</nav>

<div class="container-fluid" style="margin-top: 70px; height: calc(100vh - 80px);">
    
    <div id="alertFimTemporada" class="alert alert-success text-center shadow-lg mb-3" style="display:none;">
        <h4 class="fw-bold"><i class="fas fa-flag-checkered me-2"></i>Temporada ConcluÃ­da!</h4>
        <button class="btn btn-success fw-bold px-4" onclick="app.encerrarTemporada()">PROCESSAR ACESSOS E REBAIXAMENTOS <i class="fas fa-arrow-right ms-2"></i></button>
    </div>

    <div class="row g-3 h-100">
        
        <div class="col-lg-7 h-100 d-flex flex-column">
            <div class="card bg-dark text-white h-100 border-secondary shadow">
                <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center py-2">
                    <h6 class="mb-0 text-uppercase text-secondary fw-bold small" id="tituloPainelEsq"><i class="fas fa-table me-2"></i>ClassificaÃ§Ã£o</h6>
                    
                    <div id="filtroContainer" style="display:none;">
                        <select class="form-select form-select-sm py-0 bg-dark text-white border-secondary" id="selGrupo" onchange="app.atualizarFiltroVisual()" style="font-size: 0.8rem;">
                            </select>
                    </div>
                </div>
                
                <div class="card-body p-0 position-relative" style="overflow: hidden;">
                    <div id="viewTabela" style="height: 100%; overflow-y: auto; scrollbar-width: thin;">
                        <table class="table table-dark table-hover table-custom mb-0">
                            <thead class="sticky-top" style="z-index: 5;">
                                <tr>
                                    <th class="text-center" style="width:40px;">#</th>
                                    <th>Clube</th>
                                    <th class="text-center">P</th>
                                    <th class="text-center">J</th>
                                    <th class="text-center d-none d-sm-table-cell">V</th>
                                    <th class="text-center d-none d-sm-table-cell">E</th>
                                    <th class="text-center d-none d-sm-table-cell">D</th>
                                    <th class="text-center">SG</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyClassificacao"></tbody>
                        </table>
                    </div>

                    <div id="viewBracket" style="height: 100%; overflow-x: auto; display: none;">
                        <div id="bracketContent" class="bracket-container"></div>
                    </div>
                    
                    <div id="viewInfoCopa" style="height: 100%; display: none; align-items: center; justify-content: center; text-align: center;">
                        <div class="p-5 text-muted opacity-50">
                            <i class="fas fa-users fa-5x mb-3"></i>
                            <h3 id="txtFaseCopa" class="fw-light">Fase de Grupos</h3>
                            <p class="small">Muitos times nesta fase.<br>Utilize a lista lateral para simular os jogos.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5 h-100 pb-3 d-flex flex-column">
            <div class="card bg-dark text-white border-secondary h-100 shadow">
                <div class="card-header bg-transparent border-secondary py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="app.mudarRodada(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h6 class="mb-0 fw-bold text-warning text-uppercase small" id="lblRodada">RODADA 1</h6>
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="app.mudarRodada(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="progress" style="height: 3px; background-color: #333;"><div class="progress-bar bg-warning" id="progressBar" style="width: 0%"></div></div>
                </div>
                
                <div class="card-body p-2 bg-black bg-opacity-25" id="containerJogos" style="overflow-y: auto; scrollbar-width: thin;">
                    </div>

                <div class="card-footer bg-dark border-secondary mt-auto d-grid gap-2 p-2">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm w-50" onclick="app.simularRodada()"><i class="fas fa-play me-2"></i> Rodada</button>
                        <button class="btn btn-outline-secondary btn-sm w-50" onclick="app.simularRestante()"><i class="fas fa-forward me-2"></i> Fase</button>
                    </div>
                    <button class="btn btn-info btn-sm fw-bold" id="btnIrVolta" style="display:none;" onclick="app.irParaVolta()"><i class="fas fa-exchange-alt me-2"></i> IR PARA JOGO DE VOLTA</button>
                    <button class="btn btn-success btn-sm fw-bold" id="btnProximaFase" style="display:none;" onclick="app.avancarFase()">PRÃ“XIMA FASE <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// DADOS
// ============================================================================
const TIMES_DATA_INIT = {
    "SÃ©rie A": ["Flamengo", "Palmeiras", "Cruzeiro", "Mirassol", "Fluminense", "Botafogo", "Bahia", "SÃ£o Paulo", "GrÃªmio", "Bragantino", "AtlÃ©tico-MG", "Santos", "Corinthians", "Vasco da Gama", "VitÃ³ria", "Internacional", "Coritiba", "Athletico-PR", "Chapecoense", "Remo"],
    "SÃ©rie B": ["CearÃ¡", "Fortaleza", "Juventude", "Sport Recife", "CriciÃºma", "GoiÃ¡s", "Novorizontino", "CRB", "AvaÃ­", "CuiabÃ¡", "AtlÃ©tico-GO", "OperÃ¡rio-PR", "Vila Nova", "AmÃ©rica-MG", "Athletic", "Botafogo-SP", "Ponte Preta", "NaÃºtico", "Londrina", "SÃ£o Bernardo"],
    "SÃ©rie C": ["Caxias do Sul", "Brusque", "Guarani", "Floresta", "ConfianÃ§a", "Ypiranga", "MaringÃ¡", "Ituano", "Botafogo-PB", "Figueirense", "AnÃ¡polis", "Itabaiana", "CSA", "ABC", "RetrÃ´", "Tombense", "FerroviÃ¡ria", "Amazonas", "Volta Redonda", "Paysandu"],
    "SÃ©rie D": ["IndependÃªncia", "HumaitÃ¡", "Galvez", "CSA-AL", "ASA", "CSE", "Trem", "OratÃ³rio", "Nacional-AM", "Manaus", "AtlÃ©tico-BA", "Jacuipense", "Juaseirense", "Porto-PE", "Tirol", "FerroviÃ¡rio", "MaracanÃ£", "Iguatu", "AtlÃ©tico-CE", "Capital-DF", "Gama", "CeilÃ¢ndia", "Brasiliense", "Rio Branco-ES", "VitÃ³ria-ES", "Real Nordeste", "Aparecidense", "Goiatuba", "CRAC", "ABECAT", "Inhumas", "Sampaio CorrÃªa-MA", "Imperatriz", "Moto Club", "Iape", "Luverdense", "Primavera", "OperÃ¡rio-MT", "UniÃ£o RondonÃ³polis", "Mixto", "OperÃ¡rio-MS", "Ivinhema", "Tombense-MG", "Betim", "Democrata GV", "Pouso Alegre", "UberlÃ¢ndia", "Tuna Luso", "Ãguia de MarabÃ¡", "Sousa", "Treze", "Serra Branca", "Cascavel", "Azuriz", "SÃ£o Joseense", "Cianorte", "RetrÃ´-PE", "Central", "Maguary", "DecisÃ£o", "Altos", "PiauÃ­", "Fluminense-PI", "MaricÃ¡", "Madureira", "Nova IguaÃ§u", "AmÃ©rica-RJ", "Sampaio CorrÃªa-RJ", "Portuguesa-RJ", "ABC-RN", "Laguna", "AmÃ©rica-RN", "SÃ£o JosÃ©-RS", "Brasil de Pelotas", "SÃ£o Luiz", "Guarany", "Porto Velho", "GuaporÃ©", "GAS", "SÃ£o Raimundo-RR", "Monte Roraima", "MarcÃ­lio Dias", "Joinville", "Santa Catarina", "Blumenau", "Ãgua Santa", "Portuguesa-SP", "Velo Clube", "Noroeste", "XV de Piracicaba", "Lagarto", "Sergipe", "AraguaÃ­na", "TocantinÃ³polis", "Tocantins", "Boavista-RJ"]
};

// ForÃ§as Fixas (1 a 5 Estrelas)
let FORCAS = {
    "Flamengo": 5, "Palmeiras": 5, "Cruzeiro": 4, "Mirassol": 2, "Fluminense": 3, "Botafogo": 4, "Bahia": 3, "SÃ£o Paulo": 4, "GrÃªmio": 3, "Bragantino": 3, "AtlÃ©tico-MG": 4, "Santos": 3, "Corinthians": 3, "Vasco da Gama": 3, "VitÃ³ria": 2, "Internacional": 4, "Coritiba": 2, "Athletico-PR": 3, "Chapecoense": 2, "Remo": 1,
    "CearÃ¡": 3, "Fortaleza": 4, "Juventude": 2, "Sport Recife": 3, "CriciÃºma": 2, "GoiÃ¡s": 2, "Novorizontino": 2, "CRB": 1, "AvaÃ­": 2, "CuiabÃ¡": 2, "AtlÃ©tico-GO": 2, "OperÃ¡rio-PR": 1, "Vila Nova": 1, "AmÃ©rica-MG": 3, "Athletic": 1, "Botafogo-SP": 1, "Ponte Preta": 2, "NaÃºtico": 2, "Londrina": 1, "SÃ£o Bernardo": 1,
    "Caxias do Sul": 1, "Brusque": 1, "Guarani": 2, "Floresta": 1, "ConfianÃ§a": 1, "Ypiranga": 1, "MaringÃ¡": 1, "Ituano": 1, "Botafogo-PB": 1, "Figueirense": 2, "AnÃ¡polis": 1, "Itabaiana": 1, "CSA": 2, "ABC": 1, "RetrÃ´": 1, "Tombense": 1, "FerroviÃ¡ria": 1, "Amazonas": 1, "Volta Redonda": 1, "Paysandu": 1
};
TIMES_DATA_INIT["SÃ©rie D"].forEach(t => { if(!FORCAS[t]) FORCAS[t] = 1; });

// ============================================================================
// APP ENGINE
// ============================================================================
class App {
    constructor() {
        // VersÃ£o Final v12
        const s = JSON.parse(localStorage.getItem("simfut_brasil_v12"));
        if(s){ this.db=s.db; this.config=s.config; FORCAS=s.config.forcas; }
        else{ this.db={}; this.config={ano:2026,times:JSON.parse(JSON.stringify(TIMES_DATA_INIT)),forcas:FORCAS}; Object.keys(this.config.times).forEach(l=>this.criarLiga(l)); this.salvar(); }
        this.ligaAtual="SÃ©rie A"; this.rodadaAtual=1; this.filtroGrupo="Geral";
        this.initUI(); this.mudarLiga("SÃ©rie A"); this.checarFimTemporada();
    }
    
    initUI() {
        const l=document.getElementById("selectLiga"); l.innerHTML=""; 
        [...Object.keys(this.config.times),"Copa do Brasil"].forEach(n=>l.innerHTML+=`<option value="${n}">${n}</option>`);
        l.addEventListener('change',(e)=>this.mudarLiga(e.target.value));
        document.getElementById("anoLabel").innerText=this.config.ano;
        
        // Filtro Listener
        document.getElementById("selGrupo").addEventListener('change', (e) => this.atualizarFiltroVisual());
    }
    
    atualizarFiltroVisual() {
        this.filtroGrupo = document.getElementById("selGrupo").value;
        this.render();
    }
    
    salvar(){ localStorage.setItem("simfut_brasil_v12",JSON.stringify({db:this.db,config:this.config})); }
    exportarSave(){ const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({db:this.db,config:this.config})); const n=document.createElement('a'); n.setAttribute("href",d); n.setAttribute("download",`SimFut_${this.config.ano}.json`); document.body.appendChild(n); n.click(); n.remove(); }
    importarSave(i){ const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{try{const d=JSON.parse(e.target.result);this.db=d.db;this.config=d.config;FORCAS=d.config.forcas;this.salvar();location.reload();}catch(er){alert("Erro!");}}; r.readAsText(f); }
    hardReset(){ if(confirm("Apagar tudo?")){ localStorage.removeItem("simfut_brasil_v12"); location.reload(); } }

    criarLiga(nome) {
        if(nome==="Copa do Brasil") return;
        const times=[...this.config.times[nome]].sort(()=>.5-Math.random());
        const grupos={}; if(nome==="SÃ©rie D") { const l="ABCDEFGHIJKLMNOP".split(''); times.forEach((t,i)=>grupos[t]=l[Math.floor(i/6)]); }
        const tabela={}; times.forEach(t=>tabela[t]={P:0,J:0,V:0,E:0,D:0,GP:0,GC:0,SG:0,Grupo:grupos[t]||'-'});
        let calendario={};
        if(nome==="SÃ©rie D") {
            "ABCDEFGHIJKLMNOP".split('').forEach(l=>{
                const gt=times.filter(t=>grupos[t]===l); const cal=this.gerarRR(gt,true);
                Object.keys(cal).forEach(r=>{ if(!calendario[r]) calendario[r]=[]; calendario[r].push(...cal[r]); });
            });
        } else if(nome==="SÃ©rie C") calendario=this.gerarRR(times,false); else calendario=this.gerarRR(times,true);
        this.db[nome]={tabela,calendario,fase:1};
    }

    // --- COPA DO BRASIL (CORRIGIDA) ---
    criarCopa() {
        if(!confirm("Iniciar Copa do Brasil?")) return false;
        let tD=[...this.config.times["SÃ©rie D"]];
        if(this.db["SÃ©rie D"]){
            const t=this.db["SÃ©rie D"].tabela;
            // OrdenaÃ§Ã£o por desempenho
            if(Object.values(t).reduce((a,b)=>a+b.J,0)>0) tD.sort((a,b)=>(t[b].P-t[a].P)||(t[b].V-t[a].V)||(t[b].SG-t[a].SG));
            else tD.sort((a,b)=>(FORCAS[b]||1)-(FORCAS[a]||1)||(.5-Math.random()));
        }
        const piores=tD.slice(40), melhores=tD.slice(0,40); 
        const byes=[...this.config.times["SÃ©rie A"],...this.config.times["SÃ©rie B"],...this.config.times["SÃ©rie C"],...melhores];
        
        piores.sort(()=>.5-Math.random());
        const jogos=[]; for(let i=0;i<piores.length;i+=2) jogos.push({c:piores[i],f:piores[i+1],s:null});
        this.db["Copa do Brasil"]={tabela:{},calendario:{1:jogos},fase:1,byes:byes};
        this.salvar(); return true;
    }

    gerarRR(t,iv) {
        if(t.length%2!==0) t.push("Dummy");
        const n=t.length; const c={};
        for(let r=0;r<n-1;r++) {
            const j=[]; for(let i=0;i<n/2;i++) {
                const t1=t[i], t2=t[n-1-i];
                if(t1!=="Dummy"&&t2!=="Dummy") { if(r%2===0) j.push({c:t1,f:t2,s:null}); else j.push({c:t2,f:t1,s:null}); }
            }
            c[r+1]=j; t.splice(1,0,t.pop());
        }
        if(iv) for(let r=0;r<n-1;r++) c[r+n]=c[r+1].map(j=>({c:j.f,f:j.c,s:null}));
        return c;
    }

    mudarLiga(n) {
        if(n==="Copa do Brasil" && !this.db[n]) { if(!this.criarCopa()) { document.getElementById('selectLiga').value=this.ligaAtual; return; } }
        this.ligaAtual=n; 
        
        // Config Filtros
        const sel = document.getElementById("selGrupo");
        sel.innerHTML = '<option value="Geral">Ranking Geral</option>';
        if(n==="SÃ©rie D" && this.db[n].fase===1) "ABCDEFGHIJKLMNOP".split('').forEach(l=>sel.innerHTML+=`<option value="${l}">Grupo ${l}</option>`);
        if(n==="SÃ©rie C" && this.db[n].fase===2) { sel.innerHTML += '<option value="A">Grupo A</option><option value="B">Grupo B</option>'; this.filtroGrupo="A"; sel.value="A"; }
        else { this.filtroGrupo="Geral"; sel.value="Geral"; }
        
        const l=this.db[n]; const r=Object.keys(l.calendario).map(Number).sort((a,b)=>a-b);
        this.rodadaAtual=r[0]; for(let x of r) { if(l.calendario[x].some(j=>!j.s)) { this.rodadaAtual=x; break; } this.rodadaAtual=x; }
        this.render();
    }
    mudarRodada(d) { const n=this.rodadaAtual+d; if(this.db[this.ligaAtual].calendario[n]) { this.rodadaAtual=n; this.render(); } }
    irParaVolta() { this.mudarRodada(1); }

    // --- ENGINE SIMULATION ---
    simularPlacar(A,B) {
        let fA = FORCAS[A] || 1; let fB = FORCAS[B] || 1;
        // Lambda logic para score
        let lambdaA = Math.max(0.2, 1.35 + ((fA-fB+0.4) * 0.65)); 
        let lambdaB = Math.max(0.2, 1.35 - ((fA-fB+0.4) * 0.65));
        let gA = Math.floor(Math.random() * (lambdaA * 1.5) + Math.random());
        let gB = Math.floor(Math.random() * (lambdaB * 1.5) + Math.random());
        if(gA>6) gA=6; if(gB>6) gB=6;
        return `${gA} x ${gB}`;
    }
    simularDisputaPenal(A, B) {
        let pA=5, pB=4; if(Math.random()>.5)[pA,pB]=[pB,pA];
        return ` (${pA}-${pB} P)`;
    }

    simularUnico(idx) {
        const l=this.db[this.ligaAtual], j=l.calendario[this.rodadaAtual][idx];
        j.s = this.simularPlacar(j.c, j.f);

        // Penal Jogo Unico (Copa F1, F2, F3)
        const ehUnico = (this.ligaAtual === "Copa do Brasil" && l.fase <= 3); 
        if (ehUnico) {
            const [gA, gB] = j.s.split(" x ").map(Number);
            if (gA === gB) j.s += this.simularDisputaPenal(j.c, j.f);
        }

        // Penal Agregado (Volta)
        const ehVolta = ehRodadaVolta(this.ligaAtual, this.rodadaAtual);
        if (ehVolta) {
            const rIda = this.rodadaAtual - 1;
            if (l.calendario[rIda]) {
                const jIda = l.calendario[rIda][idx];
                const [iC, iF] = jIda.s.split(" x ").map(Number);
                const [vC, vF] = j.s.split(" x ").map(Number);
                if ((iC + vF) === (iF + vC)) j.s += this.simularDisputaPenal(j.c, j.f);
            }
        }
        
        const isMataMata = (this.ligaAtual.includes("Copa") || (this.ligaAtual=="SÃ©rie C" && l.fase>=3) || (this.ligaAtual=="SÃ©rie D" && l.fase>1));
        const ehPontosCorridos = (!isMataMata) || (this.ligaAtual=="SÃ©rie C" && l.fase===2);
        if(ehPontosCorridos && this.ligaAtual!=="Copa do Brasil") this.pts(l.tabela,j.c,j.f,j.s);

        this.salvar(); this.render(); this.checarFimTemporada();
    }

    simularRodada() { this.db[this.ligaAtual].calendario[this.rodadaAtual].forEach((j,i)=>{if(!j.s)this.simularUnico(i)}); }
    simularRestante() { if(!confirm("Simular tudo?")) return; const max=Math.max(...Object.keys(this.db[this.ligaAtual].calendario).map(Number)); for(let r=this.rodadaAtual;r<=max;r++){this.rodadaAtual=r;this.simularRodada();} }
    
    pts(tab,A,B,s) {
        const [gA,gB]=s.split(' x ').map(Number);
        if(!tab[A]||!tab[B]) return;
        [A,B].forEach(t=>tab[t].J++);
        tab[A].GP+=gA; tab[A].GC+=gB; tab[A].SG=tab[A].GP-tab[A].GC;
        tab[B].GP+=gB; tab[B].GC+=gA; tab[B].SG=tab[B].GP-tab[B].GC;
        if(gA>gB){tab[A].P+=3;tab[A].V++;tab[B].D++;} else if(gB>gA){tab[B].P+=3;tab[B].V++;tab[A].D++;} else{tab[A].P++;tab[A].E++;tab[B].P++;tab[B].E++;}
    }

    avancarFase() {
        const l=this.db[this.ligaAtual], n=this.ligaAtual;
        const getW = (i,v) => {
            if(!v) {
                if(i.s.includes("P)")) { const p=i.s.match(/\((\d+)-(\d+) P\)/); return parseInt(p[1])>parseInt(p[2])?i.c:i.f; }
                const [cA,cB]=i.s.split(' x ').map(Number); return cA>cB?i.c:i.f;
            }
            const [ic,_if]=i.s.split(' x ').map(Number), [vc,vf]=v.s.split(' x ').map(Number);
            if (v.s.includes("P)")) { const p=v.s.match(/\((\d+)-(\d+) P\)/); return parseInt(p[1])>parseInt(p[2])?v.c:i.c; }
            return (ic+vf)>(_if+vc)?i.c:v.c;
        };
        const sortPotes = (ts) => {
            ts.sort((a,b) => (FORCAS[b]||1) - (FORCAS[a]||1));
            const meio = Math.ceil(ts.length/2);
            const pA = ts.slice(0, meio).sort(()=>.5-Math.random());
            const pB = ts.slice(meio).sort(()=>.5-Math.random());
            const m = []; for(let i=0; i<pA.length; i++) { if(pB[i]) m.push({c: pB[i], f: pA[i], s: null}); }
            return m;
        };

        if(n==="SÃ©rie C" && l.fase===1) {
            const ts=Object.keys(l.tabela).sort((a,b)=>l.tabela[b].P-l.tabela[a].P || l.tabela[b].V-l.tabela[a].V || l.tabela[b].SG-l.tabela[a].SG);
            const gA=[ts[0],ts[3],ts[4],ts[7]], gB=[ts[1],ts[2],ts[5],ts[6]];
            const nT={}; [...gA,...gB].forEach(t=>nT[t]={P:0,J:0,V:0,E:0,D:0,GP:0,GC:0,SG:0,Grupo:gA.includes(t)?'A':'B'});
            l.tabela=nT; l.fase=2;
            const cA=this.gerarRR(gA,true), cB=this.gerarRR(gB,true);
            l.calendario={}; for(let i=1;i<=6;i++) l.calendario[20+i-1]=[...cA[i],...cB[i]];
            this.mudarLiga(n);
        } else if(n==="SÃ©rie C" && l.fase===2) {
             const tA = Object.keys(l.tabela).filter(t=>l.tabela[t].Grupo=='A').sort((a,b)=>l.tabela[b].P-l.tabela[a].P || l.tabela[b].SG-l.tabela[a].SG);
             const tB = Object.keys(l.tabela).filter(t=>l.tabela[t].Grupo=='B').sort((a,b)=>l.tabela[b].P-l.tabela[a].P || l.tabela[b].SG-l.tabela[a].SG);
             const ida = [ {c:tB[1],f:tA[0],s:null}, {c:tA[1],f:tB[0],s:null} ];
             const volta = [ {c:tA[0],f:tB[1],s:null}, {c:tB[0],f:tA[1],s:null} ];
             l.fase=3; l.calendario[26]=ida; l.calendario[27]=volta; this.rodadaAtual=26;
        } else if(n==="SÃ©rie D" && l.fase===1) {
            const c=[]; "ABCDEFGHIJKLMNOP".split('').forEach(k=>{
                const g=Object.keys(l.tabela).filter(t=>l.tabela[t].Grupo===k).sort((a,b)=>l.tabela[b].P-l.tabela[a].P);
                c.push(...g.slice(0,4));
            });
            l.fase=2; const ida=[], volta=[];
            c.sort(()=>.5-Math.random());
            for(let i=0;i<32;i++) { ida.push({c:c[i],f:c[63-i],s:null}); volta.push({c:c[63-i],f:c[i],s:null}); }
            l.calendario={11:ida,12:volta}; this.rodadaAtual=11;
        } else {
            const rFim = this.rodadaAtual;
            const isUnico = (n === "Copa do Brasil" && l.fase <= 3); 
            const rIni = isUnico ? rFim : rFim - 1;
            const w = [];
            if(isUnico) l.calendario[rFim].forEach(j=>w.push(getW(j,null)));
            else l.calendario[rIni].forEach((j,idx)=>w.push(getW(j,l.calendario[rFim][idx])));

            if(w.length===1) { alert(`CAMPEÃƒO: ${w[0]} ðŸ†`); return; }

            if (n==="Copa do Brasil" && l.fase===1) {
                const pool = [...w, ...l.byes];
                const jogos = sortearPotes(pool);
                l.fase = 2; l.calendario[2] = jogos; this.rodadaAtual = 2;
            }
            else if (n==="Copa do Brasil" && l.fase===2) {
                const jogos = sortearPotes(w);
                l.fase = 3; l.calendario[3] = jogos; this.rodadaAtual = 3;
            }
            else if (n==="Copa do Brasil" && l.fase===3) {
                w.sort(()=>.5-Math.random());
                const ida=[], volta=[];
                for(let i=0;i<w.length;i+=2) { ida.push({c:w[i],f:w[i+1],s:null}); volta.push({c:w[i+1],f:w[i],s:null}); }
                l.fase = 4; l.calendario[4]=ida; l.calendario[5]=volta; this.rodadaAtual = 4;
            }
            else {
                l.fase++; 
                const ida=[], volta=[];
                for(let i=0;i<w.length;i+=2) { ida.push({c:w[i],f:w[i+1],s:null}); volta.push({c:w[i+1],f:w[i],s:null}); }
                const nxt=parseInt(this.rodadaAtual)+1;
                l.calendario[nxt]=ida; l.calendario[nxt+1]=volta;
                this.rodadaAtual=nxt;
            }
        }
        this.salvar(); this.render();
    }

    checarFimTemporada() {
        let ok=true;
        ["SÃ©rie A","SÃ©rie B","SÃ©rie C","SÃ©rie D"].forEach(l=>{
            const d=this.db[l]; const max=Math.max(...Object.keys(d.calendario).map(Number));
            if(!d.calendario[max].every(j=>j.s)) ok=false;
            if((l=="SÃ©rie C" && d.fase<3) || (l=="SÃ©rie D" && d.fase<6)) ok=false;
            if(l=="SÃ©rie D" && (!d.calendario[22] || !d.calendario[22].every(j=>j.s))) ok=false;
        });
        document.getElementById("alertFimTemporada").style.display = ok ? "block" : "none";
    }

    encerrarTemporada() {
        if(!confirm("Encerrar temporada?")) return;
        const getClass = (n) => Object.keys(this.db[n].tabela).sort((a,b)=>this.db[n].tabela[b].P-this.db[n].tabela[a].P);
        const cA=getClass("SÃ©rie A"), cB=getClass("SÃ©rie B");
        const rebA=cA.slice(-4), sobB=cB.slice(0,4), rebB=cB.slice(-4);
        const sC=[]; this.db["SÃ©rie C"].calendario[26].forEach(j=>{sC.push(j.c);sC.push(j.f)});
        const rebC=this.config.times["SÃ©rie C"].filter(t=>!sC.includes(t)).sort(()=>.5-Math.random()).slice(0,4);
        const sD=[]; this.db["SÃ©rie D"].calendario[19].forEach(j=>{sD.push(j.c);sD.push(j.f)});
        const sw=(a,sub,des) => [...a.filter(x=>!des.includes(x)),...sub];
        this.config.times["SÃ©rie A"] = sw(this.config.times["SÃ©rie A"], sobB, rebA);
        this.config.times["SÃ©rie B"] = [...this.config.times["SÃ©rie B"].filter(x=>!sobB.includes(x) && !rebB.includes(x)), ...rebA, ...sC];
        this.config.times["SÃ©rie C"] = [...this.config.times["SÃ©rie C"].filter(x=>!sC.includes(x) && !rebC.includes(x)), ...rebB, ...sD];
        this.config.times["SÃ©rie D"] = [...this.config.times["SÃ©rie D"].filter(x=>!sD.includes(x)), ...rebC];
        this.config.ano++; this.db={}; Object.keys(this.config.times).forEach(l=>this.criarLiga(l));
        this.salvar(); alert("Temporada ConcluÃ­da!"); location.reload();
    }

    render() {
        const liga = this.db[this.ligaAtual];
        const isMataMata = (this.ligaAtual.includes("Copa") || (this.ligaAtual=="SÃ©rie C" && liga.fase>=3) || (this.ligaAtual=="SÃ©rie D" && liga.fase>1));
        
        document.getElementById("tituloPainelEsq").innerText = (isMataMata && this.ligaAtual!=="Copa do Brasil") ? "Diagrama Mata-Mata" : "ClassificaÃ§Ã£o";
        document.getElementById("viewTabela").style.display = "none";
        document.getElementById("viewBracket").style.display = "none";
        document.getElementById("viewInfoCopa").style.display = "none";
        document.getElementById("filtroContainer").style.display = "none";

        if (!isMataMata) {
            document.getElementById("viewTabela").style.display = "block";
            if ((this.ligaAtual === "SÃ©rie D" && liga.fase === 1) || (this.ligaAtual === "SÃ©rie C" && liga.fase === 2)) {
                document.getElementById("filtroContainer").style.display = "block";
            }
            this.renderTabela(liga);
        } else {
            if (this.ligaAtual === "Copa do Brasil" && liga.fase <= 3) {
                document.getElementById("viewInfoCopa").style.display = "flex";
                const txt = liga.fase===1 ? "Preliminar (56 Times)" : liga.fase===2 ? "1Âª Fase (128 Times)" : "2Âª Fase (64 Times)";
                document.querySelector("#viewInfoCopa h3").innerText = txt;
            } else {
                document.getElementById("viewBracket").style.display = "block";
                this.renderBracket(liga);
            }
        }

        const container = document.getElementById("containerJogos");
        container.innerHTML = "";
        let nomeR = `Rodada ${this.rodadaAtual}`;
        if(this.ligaAtual=="Copa do Brasil") nomeR = getNomeFaseLegivel(this.rodadaAtual);
        if(this.ligaAtual=="SÃ©rie C" && liga.fase==2) nomeR = `Fase de Grupos - Rodada ${this.rodadaAtual-19}`;
        if(this.ligaAtual=="SÃ©rie D" && liga.fase>1) nomeR = `Mata (${this.rodadaAtual%2!=0?'Ida':'Volta'})`;
        document.getElementById("lblRodada").innerText = nomeR;
        
        const jogos = liga.calendario[this.rodadaAtual] || [];
        const completo = jogos.every(j => j.s);
        const maxK = Math.max(...Object.keys(liga.calendario).map(Number));
        document.getElementById("progressBar").style.width = `${(this.rodadaAtual/maxK)*100}%`;

        jogos.forEach((j, idx) => {
            const pl = j.s || "-";
            const btn = !j.s ? `<button class="btn btn-warning btn-play-single ms-2" onclick="app.simularUnico(${idx})"><i class="fas fa-futbol"></i></button>` : "";
            container.innerHTML += `<div class="match-card d-flex justify-content-between align-items-center"><div class="team-name text-end">${j.c}</div><div class="score-area"><div class="score-display">${pl}</div>${btn}</div><div class="team-name text-start">${j.f}</div></div>`;
        });

        let showProx = false; let showIrVolta = false;
        if(completo) {
            if (this.rodadaAtual == maxK) {
                if(this.ligaAtual.includes("Copa")) showProx = true;
                if(this.ligaAtual=="SÃ©rie C" && liga.fase==1 && this.rodadaAtual==19) showProx=true;
                if(this.ligaAtual=="SÃ©rie C" && liga.fase==2 && this.rodadaAtual==25) showProx=true;
                if(this.ligaAtual=="SÃ©rie C" && liga.fase>2) showProx=true;
                if(this.ligaAtual=="SÃ©rie D" && liga.fase==1 && this.rodadaAtual==10) showProx=true;
                if(this.ligaAtual=="SÃ©rie D" && liga.fase>1) showProx=true;
            } else if (ehRodadaVolta(this.ligaAtual, this.rodadaAtual+1)) { showIrVolta = true; }
        }
        document.getElementById("btnProximaFase").style.display = showProx ? "block" : "none";
        document.getElementById("btnIrVolta").style.display = showIrVolta ? "block" : "none";
    }

    renderTabela(liga) {
        const tbody = document.getElementById("tbodyClassificacao");
        tbody.innerHTML = "";
        let times = Object.keys(liga.tabela);
        if((this.ligaAtual=="SÃ©rie D" || (this.ligaAtual=="SÃ©rie C" && liga.fase==2)) && this.filtroGrupo!=="Geral") times=times.filter(t=>liga.tabela[t].Grupo===this.filtroGrupo);
        times.sort((a,b) => (liga.tabela[b].P - liga.tabela[a].P) || (liga.tabela[b].SG - liga.tabela[a].SG));
        times.forEach((t, i) => {
            const d = liga.tabela[t];
            let pos = i+1; let cls = "z-neutro";
            if(this.ligaAtual=="SÃ©rie A") cls = pos<=4?"z-liberta":pos<=6?"z-prelib":pos<=12?"z-sula":pos>=17?"z-rebaix":"";
            if(this.ligaAtual=="SÃ©rie B") cls = pos<=4?"z-acesso":pos>=17?"z-rebaix":"";
            if(this.ligaAtual=="SÃ©rie C" && liga.fase==1) cls = pos<=8?"z-acesso":pos>=17?"z-rebaix":"";
            if(this.ligaAtual=="SÃ©rie C" && liga.fase==2) cls = pos<=2?"z-acesso":"";
            if(this.ligaAtual=="SÃ©rie D") { if(this.filtroGrupo=="Geral") cls = pos<=40?"z-sula":"z-rebaix"; else if(pos<=4) cls="z-acesso"; }
            tbody.innerHTML += `<tr class="${cls}"><td class="text-center fw-bold text-secondary">${pos}</td><td><small class="text-secondary me-2">${d.Grupo}</small>${t}</td><td class="text-center fw-bold text-warning">${d.P}</td><td class="text-center text-muted">${d.J}</td><td class="text-center d-none d-md-table-cell text-muted">${d.V}</td><td class="text-center text-muted">${d.SG}</td></tr>`;
        });
    }

    renderBracket(liga) {
        const container = document.getElementById("bracketContent");
        container.innerHTML = "";
        let rounds = [];
        if (this.ligaAtual === "SÃ©rie D") rounds = [11, 13, 15, 17, 19, 21];
        else if (this.ligaAtual === "SÃ©rie C") rounds = [26, 28];
        else if (this.ligaAtual === "Copa do Brasil") rounds = [4, 6, 8, 10, 12]; 
        
        rounds.forEach(rIda => {
            if (!liga.calendario[rIda]) return;
            let nm = "";
            if (this.ligaAtual === "Copa do Brasil") nm = getNomeFaseLegivel(rIda).replace(" (Ida)", "");
            else if (this.ligaAtual === "SÃ©rie D") { const offset=rIda-10; const par=Math.ceil(offset/2); const n=["","2Âª Fase","3Âª Fase","Oitavas","Quartas","Semi","Final"]; nm=n[par]; }
            else if (this.ligaAtual === "SÃ©rie C") nm = (rIda==26)?"Semifinal":"Final";

            let col = `<div class="bracket-round"><div class="bracket-title">${nm}</div>`;
            const jIda = liga.calendario[rIda];
            const jVolta = liga.calendario[rIda+1];
            jIda.forEach((ji, idx) => {
                const jv = jVolta ? jVolta[idx] : {s:null};
                const s1 = ji.s ? ji.s.split(" x ") : ["-","-"];
                const s2 = jv.s ? jv.s.split(" x ") : ["-","-"];
                let p = jv.s && jv.s.includes("P)") ? `<span class="bracket-score text-warning" style="font-size:0.7em">${jv.s.split('(')[1].replace(')', '')}</span>` : "";
                col += `<div class="bracket-match"><div class="bracket-team"><span>${ji.c}</span><span class="bracket-score">${s1[0]}</span><span class="bracket-score">${s2[1]}</span></div><div class="bracket-team"><span>${ji.f}</span><span class="bracket-score">${s1[1]}</span><span class="bracket-score">${s2[0]}</span></div>${p}</div>`;
            });
            col += `</div>`;
            container.innerHTML += col;
        });
    }
}
function getNomeFaseLegivel(r) {
    const mapa = {1: "Preliminar", 2: "1Âª Fase", 3: "2Âª Fase", 4: "32-avos (Ida)", 5: "32-avos (Volta)", 6: "Oitavas (Ida)", 7: "Oitavas (Volta)", 8: "Quartas (Ida)", 9: "Quartas (Volta)", 10: "Semi (Ida)", 11: "Semi (Volta)", 12: "Final (Ida)", 13: "Final (Volta)"};
    return mapa[r] || `Fase ${r}`;
}
function ehRodadaVolta(liga, r) {
    if (liga === "Copa do Brasil") return [5, 7, 9, 11, 13].includes(r);
    if (liga === "SÃ©rie D") return [12, 14, 16, 18, 20, 22].includes(r);
    if (liga === "SÃ©rie C") return [27, 29].includes(r);
    return false;
}
const app = new App();
</script>
</body>
</html>
